package com.example.aleppocollage.ui.auth.login.teacherimport android.os.Bundleimport android.text.method.HideReturnsTransformationMethodimport android.text.method.PasswordTransformationMethodimport android.view.Viewimport android.widget.AdapterViewimport androidx.core.content.ContextCompatimport androidx.core.view.isVisibleimport androidx.fragment.app.Fragmentimport androidx.fragment.app.activityViewModelsimport androidx.fragment.app.viewModelsimport androidx.navigation.fragment.findNavControllerimport com.example.aleppocollage.Rimport com.example.aleppocollage.databinding.FragmentRegisterTeacherBindingimport androidx.lifecycle.lifecycleScopeimport com.example.aleppocollage.model.user.domain.Teacherimport com.example.aleppocollage.ui.auth.login.student.RegisterStudentStateEventimport com.example.aleppocollage.ui.auth.login.teacher.adapter.TeacherSpinnerAdapterimport com.example.aleppocollage.ui.util.sharedviewmodel.SharedViewModelimport com.example.aleppocollage.util.Commonimport com.example.aleppocollage.util.DataStateimport dagger.hilt.android.AndroidEntryPointimport kotlinx.coroutines.delay@AndroidEntryPointclass RegisterTeacherFragment : Fragment(R.layout.fragment_register_teacher) {    ///region Variables    private var indexTeacher = -1    private var teachers: ArrayList<Teacher> = ArrayList()    //endregion    ///region ViewModel & Binding    private val viewModel: RegisterTeacherViewModel by viewModels()    private val sharedViewModel: SharedViewModel by activityViewModels()    private var _binding: FragmentRegisterTeacherBinding? = null    private val binding get() = _binding!!    ///endregion    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {        _binding = FragmentRegisterTeacherBinding.bind(view)        init()        binding.apply {            swipeRefreshRegisterTeacher.setColorSchemeColors(ContextCompat.getColor(requireContext(), R.color.colorPrimary))            swipeRefreshRegisterTeacher.setOnRefreshListener {                observeTeachersDataState()                viewModel.setStateEvent(RegisterTeacherStateEvent.GetAllTeachers)            }            btnRegisterTeacherBack.setOnClickListener {                findNavController().navigateUp()            }            btnRegisterTeacherLogin.setOnClickListener {                Common.hideKeyboard(requireActivity())                val password = binding.edtRegisterTeacherPassword.text.toString().trim()                if (indexTeacher == -1) {                    Common.showToast(requireActivity(), getString(R.string.strPleaseChooseTeacher),"warning")                    return@setOnClickListener                }                if (password.isEmpty()) {                    binding.edtRegisterTeacherPassword.error = getString(R.string.strPleaseEnterPassword)                    return@setOnClickListener                }                if (password == teachers[indexTeacher].password) {                    lifecycleScope.launchWhenCreated {                        aviRegisterTeacher.isVisible = true                        btnRegisterTeacherLogin.isVisible = false                        delay(3000)                        Common.storeCurrentUser(teacher = teachers[indexTeacher])                        val action = RegisterTeacherFragmentDirections.actionRegisterTeacherFragmentToWorkStudentOrTeacherFragment()                        findNavController().navigate(action)                        Common.showToast(requireActivity(), "Success!", "success" )                        sharedViewModel.stateStartApp.value = R.id.HomeTeacherFragment                    }                } else {                    aviRegisterTeacher.isVisible = false                    btnRegisterTeacherLogin.isVisible = true                    Common.showToast(requireActivity(), getString(R.string.strWrongPassword), "error")                }            }            spinnerRegisterTeacherName.onItemSelectedListener =                object : AdapterView.OnItemSelectedListener {                    override fun onNothingSelected(adapterView: AdapterView<*>?) {                    }                    override fun onItemSelected(                        adapterView: AdapterView<*>?, view: View?, position: Int, id: Long) {                        indexTeacher = position                    }                }            imgRegisterTeacherShowPassword.setOnClickListener {                viewModel.showPassword.value = !(viewModel.showPassword.value)!!            }        }    }    private fun init() {        observeShowPassword()        observeTeachersDataState()        viewModel.setStateEvent(RegisterTeacherStateEvent.GetAllTeachers)    }    private fun observeTeachersDataState() {        viewModel.teachersDataState.observe(viewLifecycleOwner) {            binding.apply {                when (it) {                    is DataState.Loading -> {                        swipeRefreshRegisterTeacher.isRefreshing = true                        spinnerRegisterTeacherName.isEnabled = false                        aviRegisterTeacherSpinner.isVisible = true                        txtRegisterTeacherSpinner.isVisible = false                    }                    is DataState.Success -> {                        teachers = it.data as ArrayList<Teacher>                        swipeRefreshRegisterTeacher.isRefreshing = false                        if (teachers.size > 0) {                                spinnerRegisterTeacherName.isEnabled = true                                aviRegisterTeacherSpinner.isVisible = false                                txtRegisterTeacherSpinner.isVisible = false                                val adapter = TeacherSpinnerAdapter(requireContext(), teachers)                                binding.spinnerRegisterTeacherName.adapter = adapter                            } else {                                spinnerRegisterTeacherName.isEnabled = false                                aviRegisterTeacherSpinner.isVisible = false                                txtRegisterTeacherSpinner.isVisible = true                            }                        viewModel.setStateEvent(RegisterTeacherStateEvent.None)                    }                    is DataState.Failure -> {                        teachers.clear()                        indexTeacher = -1                        swipeRefreshRegisterTeacher.isRefreshing = false                        spinnerRegisterTeacherName.isEnabled = false                        aviRegisterTeacherSpinner.isVisible = false                        txtRegisterTeacherSpinner.isVisible = true                        txtRegisterTeacherSpinner.text = getString(R.string.strThereIsNotTeachers)                        viewModel.setStateEvent(RegisterTeacherStateEvent.None)                    }                    is DataState.ExceptionState -> {                        teachers.clear()                        indexTeacher = -1                        swipeRefreshRegisterTeacher.isRefreshing = false                        spinnerRegisterTeacherName.isEnabled = false                        aviRegisterTeacherSpinner.isVisible = false                        txtRegisterTeacherSpinner.isVisible = true                        txtRegisterTeacherSpinner.text = getString(R.string.strThereIsNotTeachers)                        Common.showSnackBar(requireContext(), binding.root, getString(R.string.strThereIsProblem))                        viewModel.setStateEvent(RegisterTeacherStateEvent.None)                    }                    is DataState.Connection -> {                        teachers.clear()                        indexTeacher = -1                        swipeRefreshRegisterTeacher.isRefreshing = false                        spinnerRegisterTeacherName.isEnabled = false                        aviRegisterTeacherSpinner.isVisible = false                        txtRegisterTeacherSpinner.isVisible = true                        txtRegisterTeacherSpinner.text = getString(R.string.strThereIsNotTeachers)                        Common.showSnackBar(requireContext(), binding.root, getString(R.string.strThereIsProblem))                        viewModel.setStateEvent(RegisterTeacherStateEvent.None)                    }                }            }        }    }    private fun observeShowPassword() {        viewModel.showPassword.observe(viewLifecycleOwner) {            binding.apply {                edtRegisterTeacherPassword.transformationMethod =                    if (it!!) HideReturnsTransformationMethod() else PasswordTransformationMethod()                imgRegisterTeacherShowPassword.setBackgroundResource(if (it) R.drawable.ic_visibility_on else R.drawable.ic_visibility_off)            }        }    }    override fun onDestroyView() {        super.onDestroyView()        _binding = null    }}